# SPI (Serial Peripheral Interface) Protocol

The Serial Peripheral Interface (SPI) is a synchronous serial communication protocol widely used in embedded systems. Its high-speed capability and simplicity make it common for flash memory, sensors, displays, and other peripherals where performance is critical.

## SPI Fundamentals

### Basics of SPI

- **Synchronous Communication**: Uses a clock signal to coordinate data transfer
- **Full-Duplex**: Can simultaneously send and receive data
- **Four-Wire Interface**: MOSI, MISO, SCLK, CS/SS
- **Master-Slave Architecture**: One master controls multiple slaves
- **No Addressing Scheme**: Uses dedicated Chip Select lines for each device
- **Speed**: Much faster than IÂ²C, often 10-100 MHz

### Signal Lines

1. **SCLK (Serial Clock)**: Clock signal generated by the master
2. **MOSI (Master Out Slave In)**: Data output from master to slave
3. **MISO (Master In Slave Out)**: Data output from slave to master
4. **CS/SS (Chip Select/Slave Select)**: Activates specific slave device (active low)

### SPI Modes

Four modes based on clock polarity (CPOL) and phase (CPHA):
- **Mode 0**: CPOL=0, CPHA=0 - Clock idle low, data sampled on rising edge
- **Mode 1**: CPOL=0, CPHA=1 - Clock idle low, data sampled on falling edge
- **Mode 2**: CPOL=1, CPHA=0 - Clock idle high, data sampled on falling edge
- **Mode 3**: CPOL=1, CPHA=1 - Clock idle high, data sampled on rising edge

## Identifying SPI Interfaces

### Visual Identification

1. **Look for labeled pins**: MOSI/MISO/SCLK/CS, SPI, or abbreviations
2. **Flash memory chips**: Often connected via SPI (Winbond, Macronix, etc.)
3. **Multiple CS lines**: One per slave device
4. **Pin arrangements**: Often grouped together in 4 or more pins

### Electrical Identification

1. **Logic analyzer pattern**: Look for consistent clock signal with data lines
2. **Chip select behavior**: Active-low signals that enable specific devices
3. **Signal timing**: Data transitions relative to clock edges

## Hardware for SPI Hacking

### Essential Tools

1. **Logic analyzer**: To capture and decode SPI signals
2. **SPI adapter**: USB-to-SPI, Bus Pirate, or microcontroller-based solution
3. **Flashrom**: Software for reading/writing SPI flash chips
4. **Clips/probes**: For attaching to SPI flash chips in-circuit
5. **SOIC/WSON test clips**: For connecting to surface-mount flash chips

### Software Tools

1. **Flashrom**: Open-source utility for reading/writing SPI flash
2. **SPI Flash tools**: Vendor-specific programming tools
3. **Protocol analyzers**: Saleae Logic, Sigrok/PulseView
4. **Custom scripts**: Python/Arduino for SPI communication

## SPI Hacking Techniques

### Flash Memory Extraction

1. **In-circuit reading**: Connecting to flash while in the target system
2. **Chip removal**: Desoldering the flash chip for direct access
3. **Command sequences**: Using standard flash commands (e.g., 0x9F for JEDEC ID)
4. **Content analysis**: Examining extracted firmware for vulnerabilities

### Passive Sniffing

1. **Logic analyzer connection**: Attach to all SPI lines
2. **Boot sequence capture**: Record initialization and configuration
3. **Protocol analysis**: Decode commands and data
4. **Signal integrity**: Ensure proper connections for reliable capture

### Active Attacks

1. **Man-in-the-Middle**: Intercepting and modifying communications
2. **Bus mastering**: Taking control of the SPI bus
3. **Flash modification**: Altering firmware or configuration data
4. **Chip emulation**: Spoofing responses from SPI devices

## Common SPI Security Issues

1. **Unencrypted storage**: Firmware and sensitive data in cleartext
2. **Lack of write protection**: Unprotected flash memory
3. **Accessible test points**: Exposed SPI lines on PCB
4. **No authentication**: Any device with access can read/write
5. **Debug interfaces**: SPI programming headers left enabled
6. **Boot vulnerabilities**: Insecure verification of boot code

## Practical SPI Hacking: Flash Memory Extraction

### Extracting Firmware from SPI Flash

**Equipment needed:**
- SPI flash reader (e.g., CH341A programmer, Bus Pirate)
- SOIC clip or probe wires
- Computer with appropriate software (flashrom)
- Target device with SPI flash

**Procedure:**
1. Identify the SPI flash chip on the target board
2. Determine the chip model and pinout
3. Connect reader to appropriate pins (CS, MISO, MOSI, SCLK, GND, VCC)
4. Use flashrom to identify the chip: `flashrom -p <programmer> --chip-identify`
5. Read the chip contents: `flashrom -p <programmer> -r flash_dump.bin`
6. Verify the read with a second extraction and compare checksums
7. Analyze the extracted firmware for vulnerabilities or sensitive data

### Example: Reading a Flash Chip with Flashrom and CH341A

```bash
# Identify the flash chip
flashrom -p ch341a_spi

# Read the chip contents
flashrom -p ch341a_spi -r flash_dump.bin

# Verify with second read
flashrom -p ch341a_spi -r flash_verify.bin

# Compare checksums
md5sum flash_dump.bin flash_verify.bin
```

## Advanced SPI Techniques

### SPI Flash IC Direct Manipulation

1. **Status register modification**: Changing protection states
2. **Partial reprogramming**: Modifying specific sections
3. **Bit flipping attacks**: Targeted modification of security bits
4. **Block protection bypass**: Circumventing software write protection

### Hardware-Based Attacks

1. **Glitching**: Manipulating power or clock during operations
2. **Fault injection**: Introducing errors to bypass security
3. **Cold boot attacks**: Preserving memory contents for extraction
4. **Decapsulation**: Removing chip packaging for direct probe access

## Securing SPI Communications

As a hardware hacker, understanding proper security measures helps identify weaknesses:

1. **Hardware write protection**: Using WP pin or internal lock bits
2. **Authenticated reads/writes**: Implementing challenge-response
3. **Encrypted storage**: Encrypting sensitive data in flash
4. **Secure boot**: Cryptographic verification of firmware
5. **Physical protection**: Limiting access to SPI lines
6. **Memory scrambling**: Obfuscating stored data

## Conclusion

SPI interfaces are critical targets for hardware hackers due to their connection to firmware storage and configuration data. The protocol's simplicity and lack of built-in security make it particularly vulnerable to various attacks.

By understanding SPI communications, hardware hackers can extract firmware, modify device behavior, and potentially uncover security vulnerabilities that would be inaccessible through software alone.

In the next section, we'll explore [JTAG and SWD Protocols](./05d-jtag-swd.md), which provide even deeper access into embedded systems.
